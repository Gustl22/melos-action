name: Melos action
description: Setup Melos for you GitHub workflow
author: Lukas Klingsbo
branding:
  icon: loader
  color: purple
inputs:
  melos-version:
    description: The Melos version to make available on the path
    required: false
  run-bootstrap:
    description: 'Whether bootstrap should run or not (default: true)'
    required: false
    default: 'true'
  publish:
    description: 'Whether packages should be versioned and published (default: false)'
    required: false
    default: 'false'
runs:
  using: composite
  steps:
    - name: Activate melos
      run: dart pub global activate melos ${{ inputs.melos-version }}
      shell: bash
    - name: Run melos bootstrap
      if: ${{ inputs.run-bootstrap == 'true' }}
      run: dart pub global run melos bootstrap
      shell: bash
    - name: Add melos to PATH
      run: command -v melos || echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
      shell: bash
    - name: Run melos version
      if: ${{ inputs.publish == 'true' }}
      run: melos version
      shell: bash
    - name: Run melos publish --dry-run
      if: ${{ inputs.publish == 'true' }}
      run: melos publish --dry-run
      shell: bash
    - name: Run melos publish --no-dry-run
      if: ${{ inputs.publish == 'true' }}
      run: melos publish --dry-run # Change to --no-dry-run once it is certain it works
      shell: bash
    - name: Create Pull Request with changes
      if: ${{ inputs.publish == 'true' }}
      uses: peter-evans/create-pull-request@v5
      with:
        title: 'chore(release): Publish packages'
        body: 'Updated CHANGELOG.md and pubspec.yaml for all packages after release to pub.dev'
        branch: release
